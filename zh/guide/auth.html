<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="FaasJS Custom SSG" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      try {
        const useChoice = localStorage.getItem('vuepress-color-scheme');
        const systemStatus =
          'matchMedia' in window
            ? window.matchMedia('(prefers-color-scheme: dark)').matches
            : false;

        if (useChoice === 'light') {
          document.documentElement.dataset.theme = 'light';
        } else if (useChoice === 'dark' || systemStatus) {
          document.documentElement.dataset.theme = 'dark';
        }
      } catch {}
    </script>
    <link rel="icon" href="/logo.jpg" />
    <title>5 分钟开发登录注册功能 | FaasJS</title>
    <meta name="description" content="一个基于 Typescript 的原子化应用框架" />
    <link rel="stylesheet" href="/assets/style.css" />
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0049636498302507" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143006612-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'UA-143006612-1');
    </script>
  </head>
  <body>
    <div id="app">
      <div class="vp-theme-container external-link-icon">
        <header class="vp-navbar" vp-navbar>
          <div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0">
            <div class="icon" aria-hidden="true"><span></span><span></span><span></span></div>
          </div>
          <span>
            <a class="route-link" href="/zh/"><span class="vp-site-name" aria-hidden="true">FaasJS</span></a>
          </span>
          <div class="vp-navbar-items-wrapper"><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><div class="vp-navbar-item"><a class="auto-link route-link route-link-active" href="/zh/" aria-label="首页">首页</a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="学习"><span class="title">学习</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="学习"><span class="title">学习</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link route-link route-link-active" href="/zh/guide/" aria-label="教程">教程</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/zh/doc/" aria-label="文档">文档</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/CHANGELOG.html" aria-label="更新日志">更新日志</a></li></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="生态"><span class="title">生态</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="生态"><span class="title">生态</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link external-link" href="https://marketplace.visualstudio.com/items?itemName=FaasJS.faasjs-snippets" aria-label="VS Code 插件" rel="noopener noreferrer" target="_blank">VS Code 插件</a></li><li class="vp-navbar-dropdown-item"><h4 class="vp-navbar-dropdown-subtitle"><span>Docker 镜像</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><li class="vp-navbar-dropdown-subitem"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/tree/main/images/nginx" aria-label="faasjs/nginx" rel="noopener noreferrer" target="_blank">faasjs/nginx</a></li><li class="vp-navbar-dropdown-subitem"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/tree/main/images/node" aria-label="faasjs/node" rel="noopener noreferrer" target="_blank">faasjs/node</a></li><li class="vp-navbar-dropdown-subitem"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/tree/main/images/vscode" aria-label="faasjs/vscode" rel="noopener noreferrer" target="_blank">faasjs/vscode</a></li></ul></li></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="社区"><span class="title">社区</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="社区"><span class="title">社区</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/" aria-label="Github" rel="noopener noreferrer" target="_blank">Github</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/CONTRIBUTING.html" aria-label="支持 FaasJS">支持 FaasJS</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link external-link" href="https://github.com/sponsors/faasjs" aria-label="赞助 FaasJS" rel="noopener noreferrer" target="_blank">赞助 FaasJS</a></li></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="简体中文"><span class="title">简体中文</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="简体中文"><span class="title">简体中文</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/" aria-label="English">English</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link route-link-active" href="/zh/guide/auth.html" aria-label="简体中文">简体中文</a></li></ul></div></div></nav></div>
        </header>
        <div class="vp-sidebar-mask"></div>
        <aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><div class="vp-navbar-item"><a class="auto-link route-link route-link-active" href="/zh/" aria-label="首页">首页</a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper mobile"><button class="vp-navbar-dropdown-title" type="button" aria-label="学习"><span class="title">学习</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="学习"><span class="title">学习</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link route-link route-link-active" href="/zh/guide/" aria-label="教程">教程</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/zh/doc/" aria-label="文档">文档</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/CHANGELOG.html" aria-label="更新日志">更新日志</a></li></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper mobile"><button class="vp-navbar-dropdown-title" type="button" aria-label="生态"><span class="title">生态</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="生态"><span class="title">生态</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link external-link" href="https://marketplace.visualstudio.com/items?itemName=FaasJS.faasjs-snippets" aria-label="VS Code 插件" rel="noopener noreferrer" target="_blank">VS Code 插件</a></li><li class="vp-navbar-dropdown-item"><h4 class="vp-navbar-dropdown-subtitle"><span>Docker 镜像</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><li class="vp-navbar-dropdown-subitem"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/tree/main/images/nginx" aria-label="faasjs/nginx" rel="noopener noreferrer" target="_blank">faasjs/nginx</a></li><li class="vp-navbar-dropdown-subitem"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/tree/main/images/node" aria-label="faasjs/node" rel="noopener noreferrer" target="_blank">faasjs/node</a></li><li class="vp-navbar-dropdown-subitem"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/tree/main/images/vscode" aria-label="faasjs/vscode" rel="noopener noreferrer" target="_blank">faasjs/vscode</a></li></ul></li></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper mobile"><button class="vp-navbar-dropdown-title" type="button" aria-label="社区"><span class="title">社区</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="社区"><span class="title">社区</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link external-link" href="https://github.com/faasjs/faasjs/" aria-label="Github" rel="noopener noreferrer" target="_blank">Github</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/CONTRIBUTING.html" aria-label="支持 FaasJS">支持 FaasJS</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link external-link" href="https://github.com/sponsors/faasjs" aria-label="赞助 FaasJS" rel="noopener noreferrer" target="_blank">赞助 FaasJS</a></li></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper mobile"><button class="vp-navbar-dropdown-title" type="button" aria-label="简体中文"><span class="title">简体中文</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="简体中文"><span class="title">简体中文</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown"><li class="vp-navbar-dropdown-item"><a class="auto-link route-link" href="/" aria-label="English">English</a></li><li class="vp-navbar-dropdown-item"><a class="auto-link route-link route-link-active" href="/zh/guide/auth.html" aria-label="简体中文">简体中文</a></li></ul></div></div></nav><ul class="vp-sidebar-items"><li><a class="vp-sidebar-item vp-sidebar-heading" href="/zh/guide/" aria-label="1 分钟上手">1 分钟上手</a></li><li><a class="vp-sidebar-item vp-sidebar-heading active" href="/zh/guide/auth.html" aria-label="5 分钟开发登录注册功能">5 分钟开发登录注册功能</a></li><li><p class="vp-sidebar-heading">进阶学习</p><ul class="vp-sidebar-items"><li><a class="vp-sidebar-item" href="/zh/guide/excel/faas-yaml.html" aria-label="faas.yaml">faas.yaml</a></li><li><a class="vp-sidebar-item" href="/zh/guide/excel/plugin.html" aria-label="使用插件">使用插件</a></li><li><a class="vp-sidebar-item" href="/zh/guide/excel/http.html" aria-label="Http、Cookie 和 Session">Http、Cookie 和 Session</a></li><li><a class="vp-sidebar-item" href="/zh/guide/excel/db.html" aria-label="数据库操作">数据库操作</a></li><li><a class="vp-sidebar-item" href="/zh/guide/excel/request-spec.html" aria-label="HTTP 请求规范">HTTP 请求规范</a></li><li><a class="vp-sidebar-item" href="/zh/guide/excel/env.html" aria-label="环境变量">环境变量</a></li><li><a class="vp-sidebar-item" href="/zh/guide/excel/react.html" aria-label="在 React 中使用">在 React 中使用</a></li></ul></li><li><a class="vp-sidebar-item vp-sidebar-heading" href="/zh/guide/story.html" aria-label="背景故事">背景故事</a></li></ul></aside>
        <main class="vp-page">
          <div vp-content>
            <div id="content"><div class="theme-default-content"><h1 id="5-%E5%88%86%E9%92%9F%E5%BC%80%E5%8F%91%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD" tabindex="-1">5 分钟开发登录注册功能</h1>
<p>在学习本教程前，建议先学习 <a href="/zh/guide/">1 分钟上手</a>。</p>
<p>通过本教程，你将学到：</p>
<ul>
<li>如何将需求拆解为云函数？</li>
<li>如何使用 Session 来识别用户？</li>
<li>如何使用入参校验来避免恶意攻击？</li>
<li>如何在云函数中使用 Sql？</li>
</ul>
<h2 id="%E6%A2%B3%E7%90%86%E9%9C%80%E6%B1%82" tabindex="-1">梳理需求</h2>
<p>为了简化教程，我们将登陆注册功能，限定为仅支持使用用户名和密码来注册和登录。</p>
<p>因此把功能点梳理为：</p>
<ul>
<li>用户可以通过输入用户名和密码，来完成注册；</li>
<li>注册完成后直接成为已登录状态；</li>
<li>在已登录状态下，用户可以修改自己的密码；</li>
<li>用户可以登出；</li>
<li>用户可以登录；</li>
</ul>
<p>为了实现需求，我们需要分两步来设计：数据库设计和云函数设计。</p>
<p>先确定数据库表结构为：</p>
<ul>
<li><strong>users</strong> 表名
<ul>
<li><strong>id</strong> <code>number</code> 自增主键</li>
<li><strong>username</strong> <code>string</code> 用户名，不可重复</li>
<li><strong>password</strong> <code>string</code> 密码（这里为了简化教程，密码采用明码保存，在实际业务中请务必加密保存！！）</li>
</ul>
</li>
</ul>
<p>接下来，云函数的设计，需要根据业务流程来梳理，通常来说，有几个业务流程，就创建几个云函数：</p>
<ul>
<li>注册流程
<ul>
<li>入参：用户名、密码</li>
<li>出参：在 seesion 中保存用户 ID</li>
<li>业务逻辑：把用户名和密码保存到数据库中，并在 seesion 中保存用户 ID</li>
</ul>
</li>
<li>登录流程
<ul>
<li>入参：用户名、密码</li>
<li>出参：在 seesion 中保存用户 ID</li>
<li>业务逻辑：检查用户名和密码是否与数据库中保存的一致，一致则在 seesion 中写入用户 ID</li>
</ul>
</li>
<li>登出流程
<ul>
<li>入参：seesion 中当前登录用户的 ID</li>
<li>出参：删除 session 的登录用户 ID</li>
<li>业务逻辑：删除 session 中的用户 ID</li>
</ul>
</li>
<li>修改密码：
<ul>
<li>入参：新密码、旧密码、seesion 中当前登录用户的 ID</li>
<li>出参：无</li>
<li>业务逻辑：检查旧密码是否与数据库中存储的一致，一致的话替换为新密码</li>
</ul>
</li>
</ul>
<p>基于以上梳理，我们知道了要完成这个功能，我们需要创建 1 张数据库表和 4 个云函数。</p>
<h2 id="%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B" tabindex="-1">注册流程</h2>
<p>数据库建表这里就略过了，我们直接从云函数开始写起。</p>
<p>我们按上面列出的业务逻辑顺序，来写云函数，首先是注册流程。</p>
<p>我们先手动创建云函数文件 <code>users/api/signup.func.ts</code>：</p>
<p>然后在云函数文件中写业务代码：</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// users/api/signup.func.ts</span>
<span class="hljs-keyword">import</span> { defineApi, z } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@faasjs/core&#x27;</span>

<span class="hljs-keyword">const</span> schema = z
  .<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">username</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">password</span>: z.<span class="hljs-title function_">string</span>(),
  })
  .<span class="hljs-title function_">required</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> func = <span class="hljs-title function_">defineApi</span>({
  schema,
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">{ knex, params, session }</span>) {
    <span class="hljs-keyword">if</span> (!knex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;缺少插件配置&#x27;</span>)
    }

    <span class="hljs-keyword">const</span> row = <span class="hljs-keyword">await</span> <span class="hljs-title function_">knex</span>(<span class="hljs-string">&#x27;users&#x27;</span>)
      .<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;password&#x27;</span>)
      .<span class="hljs-title function_">where</span>(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-string">&#x27;=&#x27;</span>, params.<span class="hljs-property">username</span>)
      .<span class="hljs-title function_">first</span>()

    <span class="hljs-keyword">if</span> (!row) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;用户名错误&#x27;</span>)
    }

    <span class="hljs-keyword">if</span> (row.<span class="hljs-property">password</span> !== params.<span class="hljs-property">password</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;用户名或密码错误&#x27;</span>)
    }

    session.<span class="hljs-title function_">write</span>(<span class="hljs-string">&#x27;user_id&#x27;</span>, row.<span class="hljs-property">id</span>)
  },
})
</code></pre>
<p>为了验证我们写的代码是否正确，我们需要写单元测试代码。</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// users/api/__tests__/signup.test.ts</span>
<span class="hljs-keyword">import</span> { useKnex } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@faasjs/core&#x27;</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FuncWarper</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@faasjs/dev&#x27;</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;signin&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FuncWarper</span>(<span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;../signin.func&#x27;</span>))

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">useKnex</span>().<span class="hljs-title function_">raw</span>(<span class="hljs-string">&quot;INSERT INTO users (id,username,password) VALUES (1,&#x27;hello&#x27;,&#x27;world&#x27;)&quot;</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;should work&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> func.<span class="hljs-title class_">JSON</span>handler({
      <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;hello&#x27;</span>,
      <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;world&#x27;</span>,
    })

    <span class="hljs-title function_">expect</span>(func.<span class="hljs-property">http</span>.<span class="hljs-property">session</span>.<span class="hljs-title function_">decode</span>(res.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Set-Cookie&#x27;</span>][<span class="hljs-number">0</span>].<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/key=([^;]+)/</span>)[<span class="hljs-number">1</span>])).<span class="hljs-title function_">toEqual</span>({
      <span class="hljs-attr">user_id</span>: <span class="hljs-number">1</span>,
    })
    <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">statusCode</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-number">204</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;wrong username&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> func.<span class="hljs-title class_">JSON</span>handler({
      <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;&#x27;</span>,
      <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;&#x27;</span>,
    })

    <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">statusCode</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-number">500</span>)
    <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">body</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">&#x27;{&quot;error&quot;:{&quot;message&quot;:&quot;用户名错误&quot;}}&#x27;</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;wrong password&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> func.<span class="hljs-title class_">JSON</span>handler({
      <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;hello&#x27;</span>,
      <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;&#x27;</span>,
    })

    <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">statusCode</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-number">500</span>)
    <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">body</span>).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">&#x27;{&quot;error&quot;:{&quot;message&quot;:&quot;用户名或密码错误&quot;}}&#x27;</span>)
  })
})
</code></pre>
<h2 id="%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B" tabindex="-1">登录流程</h2>
<p>先创建 <code>users/api/signin.func.ts</code> 文件：</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// users/api/signin.func.ts</span>
<span class="hljs-keyword">import</span> { defineApi, z } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@faasjs/core&#x27;</span>

<span class="hljs-keyword">const</span> schema = z
  .<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">username</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">password</span>: z.<span class="hljs-title function_">string</span>(),
  })
  .<span class="hljs-title function_">required</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> func = <span class="hljs-title function_">defineApi</span>({
  schema,
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">{ knex, params, session }</span>) {
    <span class="hljs-keyword">if</span> (!knex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;缺少插件配置&#x27;</span>)
    }

    <span class="hljs-keyword">const</span> row = <span class="hljs-keyword">await</span> <span class="hljs-title function_">knex</span>(<span class="hljs-string">&#x27;users&#x27;</span>)
      .<span class="hljs-title function_">where</span>({ <span class="hljs-attr">username</span>: params.<span class="hljs-property">username</span> })
      .<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;password&#x27;</span>)
      .<span class="hljs-title function_">first</span>()
    <span class="hljs-keyword">if</span> (!row) {
      <span class="hljs-comment">// 在云函数中，建议直接通过抛异常的方式来告知前端错误信息</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;用户名错误&#x27;</span>)
    }
    <span class="hljs-keyword">if</span> (row.<span class="hljs-property">password</span> !== params.<span class="hljs-property">password</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;用户名或密码错误&#x27;</span>)
    }

    session.<span class="hljs-title function_">write</span>(<span class="hljs-string">&#x27;user_id&#x27;</span>, row.<span class="hljs-property">id</span>)
  },
})
</code></pre>
<h2 id="%E7%99%BB%E5%87%BA%E6%B5%81%E7%A8%8B" tabindex="-1">登出流程</h2>
<p>先创建 <code>users/api/signout.func.ts</code> 文件：</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// users/api/signout.func.ts</span>
<span class="hljs-keyword">import</span> { defineApi } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@faasjs/core&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> func = <span class="hljs-title function_">defineApi</span>({
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">{ session }</span>) {
    session.<span class="hljs-title function_">write</span>(<span class="hljs-string">&#x27;user_id&#x27;</span>, <span class="hljs-literal">null</span>)
  },
})
</code></pre>
<h2 id="%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%E6%B5%81%E7%A8%8B" tabindex="-1">修改密码流程</h2>
<p>先创建 <code>users/api/change-password.func.ts</code> 文件：</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// users/api/change-password.func.ts</span>
<span class="hljs-keyword">import</span> { defineApi, z } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@faasjs/core&#x27;</span>

<span class="hljs-keyword">const</span> schema = z
  .<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">new_password</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">old_password</span>: z.<span class="hljs-title function_">string</span>(),
  })
  .<span class="hljs-title function_">required</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> func = <span class="hljs-title function_">defineApi</span>({
  schema,
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">{ knex, params, session }</span>) {
    <span class="hljs-keyword">if</span> (!knex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;缺少插件配置&#x27;</span>)
    }

    <span class="hljs-keyword">const</span> userId = session.<span class="hljs-title function_">read</span>(<span class="hljs-string">&#x27;user_id&#x27;</span>)

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> userId !== <span class="hljs-string">&#x27;number&#x27;</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;未登录&#x27;</span>)
    }

    <span class="hljs-keyword">const</span> row = <span class="hljs-keyword">await</span> <span class="hljs-title function_">knex</span>(<span class="hljs-string">&#x27;users&#x27;</span>).<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;password&#x27;</span>).<span class="hljs-title function_">where</span>(<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;=&#x27;</span>, userId).<span class="hljs-title function_">first</span>()
    <span class="hljs-keyword">if</span> (row.<span class="hljs-property">password</span> !== params.<span class="hljs-property">old_password</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;旧密码错误&#x27;</span>)
    }
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">knex</span>(<span class="hljs-string">&#x27;users&#x27;</span>).<span class="hljs-title function_">where</span>(<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;=&#x27;</span>, userId).<span class="hljs-title function_">update</span>({
      <span class="hljs-attr">password</span>: params.<span class="hljs-property">new_password</span>,
    })
  },
})
</code></pre>
<h2 id="%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81" tabindex="-1">完整项目代码</h2>
<p>完整的项目代码在 <a href="https://github.com/faasjs/faasjs/examples/tree/main/auth" target="_blank" rel="noopener noreferrer" class="external-link">https://github.com/faasjs/faasjs/examples/tree/main/auth</a> 其中还包括了完整的测试用例代码。</p>
</div></div>
          </div>
          
        </main>
      </div>
    </div>
    <script src="/assets/app.js" defer></script>
  </body>
</html>